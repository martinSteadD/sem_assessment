# Name of the workflow as it appears in the GitHub Actions UI
name: A workflow for the Population App

# This will trigger the workflow on every push to the repository
on: push

jobs:

  # -----------------------
  # Unit Tests Job
  # -----------------------
  UnitTests:
    name: Run Unit Tests
    runs-on: ubuntu-22.04

    steps:
      # Step 1: Checkout repository
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # Step 2: Set up Java JDK 17
      - name: Set up JDK 17
        uses: actions/setup-java@v2
        with:
          java-version: '17'
          distribution: 'adopt'

      # Step 3: Run Unit Tests using Maven
      - name: Unit Tests
        run: mvn -Dtest=com.napier.sem.SimpleUnitTest test
        # Executes the unit test file SimpleUnitTest.java

    # -----------------------
    # Integration Tests Job
    # -----------------------
  IntegrationTests:
      name: Run Integration Tests
      runs-on: ubuntu-22.04

      steps:
        # Step 1: Checkout repository
        - name: Checkout
          uses: actions/checkout@v4
          with:
            submodules: recursive

        # Step 2: Set up Java JDK 17
        - name: Set up JDK 17
          uses: actions/setup-java@v2
          with:
            java-version: '17'
            distribution: 'adopt'

        # Step 3: Build Docker image for database
        - name: Build database Docker image
          run: docker build -t database ./db
          # Builds MySQL database image located in ./db folder

        # Step 4: Run database container
        - name: Start database container
          run: docker run --name employees -dp 33060:3306 database
          # Exposes container MySQL on localhost:33060 for integration tests

        # Step 5: Run Integration Tests
        - name: Integration Tests
          run: mvn -Dtest=com.napier.sem.PopulationAppIntegrationTest test
          # Executes database-dependent tests

        # Step 6: Stop and remove container after tests
        - name: Stop and remove database container
          run: |
            docker stop employees
            docker rm employees
            docker image rm database
          # Clean up after integration testing

        # Step 7: Upload code coverage to Codecov
        - name: Codecov
          uses: codecov/codecov-action@v2
          with:
            directory: ./target/site/jacoco
            flags: IntegrationTests
            verbose: true

  build:
    # Job name shown in the Actions UI
    name: population action

    # Specifies the running environment (Ubuntu 22.04)
    runs-on: ubuntu-22.04

    steps:
      # Step 1: Checkout the repository code
      - name: Checkout
        uses: actions/checkout@v4
        # This pulls the latest code from the repo into the running environment

      # Step 2: Sets up Java Development Kit (JDK) version 17
      - name: Set up JDK 17
        uses: actions/setup-java@v2
        with:
          java-version: '17'         # Specifies the Java version
          distribution: 'adopt'      # Uses AdoptOpenJDK distribution



      # Step 4: Compiles and packages the Java app using Maven
      - name: Package with Maven
        run: mvn clean compile assembly:single
        # Cleans previous builds, compiles the code, and packages it into a single JAR

      # Step 5: Builds the Docker image for the application
      - name: Build
        run: docker build -t sem_assessment .
        # Builds the Docker image using the Dockerfile in the repo

        #Step 6 Package and run docker compose
      - name: Package and Run docker compose
        run: |
          mvn package -DskipTests
          docker compose up --abort-on-container-exit

      # Step 7: Outputs logs from the running container
      - name: View logs
        run: docker logs sem_assessment-app-1
        # Displays the container logs for debugging or verification

